<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Income & Expenses Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #17a2b8;
            --light: #ecf0f1;
            --dark: #34495e;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--primary);
            color: white;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .wallet-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-menu {
            padding: 15px 0;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid var(--secondary);
        }

        .sidebar-menu i {
            margin-right: 10px;
            font-size: 18px;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e5ee;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-info {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .clock, .calendar {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        /* Report Controls */
        .report-controls {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5ee;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5ee;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .report-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-info {
            background: var(--info);
        }

        .btn-info:hover {
            background: #148ea1;
        }

        /* Report Summary */
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-top: 4px solid;
        }

        .summary-card.income {
            border-top-color: var(--success);
        }

        .summary-card.expense {
            border-top-color: var(--danger);
        }

        .summary-card.balance {
            border-top-color: var(--info);
        }

        .summary-card.net {
            border-top-color: #9b59b6;
        }

        .summary-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .summary-card h3 {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .summary-amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .summary-trend {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Report Sections */
        .report-sections {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .report-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h2 {
            font-size: 18px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Charts */
        .chart-container {
            margin-bottom: 25px;
        }

        .chart-placeholder {
            height: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Report Tables */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .report-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #e1e5ee;
        }

        .report-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5ee;
        }

        .report-table tr:hover {
            background: #f8f9fa;
        }

        .amount-positive {
            color: var(--success);
            font-weight: 600;
        }

        .amount-negative {
            color: var(--danger);
            font-weight: 600;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .category-income {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }

        .category-expense {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* Balance Report Table */
        .balance-report-table th,
        .balance-report-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5ee;
        }

        .balance-report-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        /* Export Options */
        .export-options {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .export-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: #148ea1;
            transform: translateY(-2px);
        }

        .export-btn.csv {
            background: var(--success);
        }

        .export-btn.csv:hover {
            background: #27ae60;
        }

        .export-btn.excel {
            background: var(--warning);
        }

        .export-btn.excel:hover {
            background: #e67e22;
        }

        .export-btn.html {
            background: var(--danger);
        }

        .export-btn.html:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-state .small {
            font-size: 14px;
        }

        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .preview-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .preview-header {
            padding: 20px;
            border-bottom: 1px solid #e1e5ee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-body {
            padding: 20px;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #e1e5ee;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .report-sections {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                z-index: 1000;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-info {
                width: 100%;
                justify-content: space-between;
            }

            .clock, .calendar {
                flex: 1;
                text-align: center;
                font-size: 12px;
                padding: 6px 8px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .report-actions {
                flex-direction: column;
            }

            .report-summary {
                grid-template-columns: 1fr 1fr;
            }

            .report-sections {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                grid-template-columns: 1fr;
            }

            .report-table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }

            .report-summary {
                grid-template-columns: 1fr;
            }

            .summary-card {
                padding: 20px;
            }

            .summary-amount {
                font-size: 20px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .export-btn {
                padding: 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="wallet-icon">üí∞</div>
                <h2>Income & Expenses Tracker</h2>
                <p id="userVoucher">Voucher: Loading...</p>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="dashboard.html"><i>üìä</i> Dashboard</a></li>
                    <li><a href="categories.html"><i>üìÇ</i> Categories</a></li>
                    <li><a href="balance.html"><i>üí∞</i> Balance</a></li>
                    <li><a href="entries.html"><i>‚ûï</i> Entries</a></li>
                    <li><a href="creditors.html"><i>üë•</i> Creditors</a></li>
                    <li><a href="debtors.html"><i>üë§</i> Debtors</a></li>
                    <li><a href="notes.html"><i>üìù</i> Notes</a></li>
                    <li><a href="rectify.html"><i>‚úèÔ∏è</i> Rectify</a></li>
                    <li><a href="reports.html" class="active"><i>üìà</i> Reports</a></li>
                    <li><a href="admin.html"><i>‚öôÔ∏è</i> Admin</a></li>
                    <li><a href="settings.html"><i>üîß</i> Settings</a></li>
                    <li><a href="#" id="logoutBtn"><i>üö™</i> Logout</a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <h1>Financial Reports</h1>
                <div class="header-info">
                    <div class="calendar" id="currentDate">Loading...</div>
                    <div class="clock" id="currentTime">Loading...</div>
                </div>
            </div>

            <!-- Report Controls -->
            <div class="report-controls">
                <div class="controls-grid">
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select class="form-select" id="reportType">
                            <option value="summary">Summary Report</option>
                            <option value="detailed">Detailed Report</option>
                            <option value="category">Category-wise</option>
                            <option value="balance">Balance Report</option>
                            <option value="creditors">Creditors Report</option>
                            <option value="debtors">Debtors Report</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportPeriod">Period</label>
                        <select class="form-select" id="reportPeriod">
                            <option value="custom">Custom Range</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="thisWeek">This Week</option>
                            <option value="lastWeek">Last Week</option>
                            <option value="thisMonth" selected>This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="thisQuarter">This Quarter</option>
                            <option value="lastQuarter">Last Quarter</option>
                            <option value="thisYear">This Year</option>
                            <option value="lastYear">Last Year</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="fromDate">From Date</label>
                        <input type="date" class="form-control" id="fromDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="toDate">To Date</label>
                        <input type="date" class="form-control" id="toDate">
                    </div>
                </div>
                
                <div class="report-actions">
                    <button class="btn btn-warning" id="clearFilters">
                        <span>üóëÔ∏è</span> Clear Filters
                    </button>
                    <button class="btn btn-info" id="previewReport">
                        <span>üëÅÔ∏è</span> Preview Report
                    </button>
                    <button class="btn btn-success" id="generateReport">
                        <span>üìä</span> Generate Report
                    </button>
                </div>
            </div>

            <!-- Report Summary -->
            <div class="report-summary">
                <div class="summary-card income">
                    <div class="summary-icon">üì•</div>
                    <h3>TOTAL INCOME</h3>
                    <div class="summary-amount" id="totalIncome">‚Çπ0</div>
                    <div class="summary-trend" id="incomeTrend">From entries only</div>
                </div>
                <div class="summary-card expense">
                    <div class="summary-icon">üì§</div>
                    <h3>TOTAL EXPENSES</h3>
                    <div class="summary-amount" id="totalExpenses">‚Çπ0</div>
                    <div class="summary-trend" id="expenseTrend">From entries only</div>
                </div>
                <div class="summary-card net">
                    <div class="summary-icon">üí∞</div>
                    <h3>NET INCOME</h3>
                    <div class="summary-amount" id="netIncome">‚Çπ0</div>
                    <div class="summary-trend" id="netTrend">Income - Expenses</div>
                </div>
                <div class="summary-card balance">
                    <div class="summary-icon">üè¶</div>
                    <h3>TRANSACTIONS</h3>
                    <div class="summary-amount" id="transactionCount">0</div>
                    <div class="summary-trend" id="balanceTrend">Filtered count</div>
                </div>
            </div>

            <!-- Report Sections -->
            <div class="report-sections">
                <!-- Main Report Content -->
                <div class="report-section">
                    <div class="section-header">
                        <h2><span>üìà</span> Report Details</h2>
                        <span class="summary-trend" id="reportRange">No data</span>
                    </div>
                    
                    <div class="table-container" id="reportTableContainer">
                        <!-- Report tables will be loaded here based on report type -->
                    </div>
                </div>

                <!-- Sidebar Charts -->
                <div class="report-section">
                    <div class="section-header">
                        <h2><span>üìä</span> Report Summary</h2>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-placeholder" id="summaryChart">
                            Report summary will appear here
                        </div>
                    </div>
                    
                    <div class="section-header" style="margin-top: 30px;">
                        <h2><span>üìã</span> Quick Stats</h2>
                    </div>
                    
                    <div class="quick-stats" id="quickStats">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #7f8c8d;">Income Transactions</div>
                            <div style="font-size: 18px; font-weight: 700;" id="incomeCount">0</div>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #7f8c8d;">Expense Transactions</div>
                            <div style="font-size: 18px; font-weight: 700;" id="expenseCount">0</div>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #7f8c8d;">Average Transaction</div>
                            <div style="font-size: 18px; font-weight: 700;" id="averageAmount">‚Çπ0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="export-options">
                <div class="section-header">
                    <h2><span>üì§</span> Export Report</h2>
                </div>
                
                <p>Export your financial report in various formats for analysis or sharing:</p>
                
                <div class="export-buttons">
                    <button class="export-btn csv" id="exportCSV">
                        <span>üìÑ</span>
                        <span>CSV Format</span>
                        <small>Excel compatible</small>
                    </button>
                    <button class="export-btn excel" id="exportExcel">
                        <span>üìä</span>
                        <span>Excel Format</span>
                        <small>Advanced formatting</small>
                    </button>
                    <button class="export-btn html" id="exportHTML">
                        <span>üåê</span>
                        <span>HTML Format</span>
                        <small>Web ready</small>
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>¬© 2023 Income & Expenses Tracker | Made by Shankar</p>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <h3>Report Preview</h3>
                <button class="close-preview">&times;</button>
            </div>
            <div class="preview-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentReportData = null;
        let filteredTransactions = [];
        let currentReportType = 'summary';

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser || !currentUser.voucherCode) {
                window.location.href = 'index.html';
                return;
            }
            
            // Display user voucher
            document.getElementById('userVoucher').textContent = `Voucher: ${currentUser.voucherCode}`;
            
            // Set default date range (current month)
            updateDateRangeByPeriod('thisMonth');
            
            // Load initial report
            loadReportData(currentUser.voucherCode);
            
            // Update clock and calendar
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup mobile menu
            setupMobileMenu();
        });

        // Mobile menu functionality
        function setupMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking on a link (mobile)
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });

            // Close sidebar when clicking outside (mobile)
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768 && 
                    sidebar.classList.contains('active') &&
                    !sidebar.contains(event.target) &&
                    !mobileMenuToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            });
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            
            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
            
            // Format time
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US');
        }

        // Load report data
        function loadReportData(voucherCode) {
            const userData = JSON.parse(localStorage.getItem(`userData_${voucherCode}`));
            
            if (userData) {
                // Get date range
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                currentReportType = document.getElementById('reportType').value;
                
                // Filter transactions by date and type
                filteredTransactions = filterTransactions(userData.transactions || [], fromDate, toDate, currentReportType);
                
                // Calculate report data - FIXED: Only count entries, exclude creditor/debtor transactions
                currentReportData = calculateReportData(filteredTransactions, userData);
                
                // Update UI
                updateReportSummary(currentReportData, userData.settings.currency);
                updateReportTable(currentReportData, userData, currentReportType);
                updateQuickStats(currentReportData, userData.settings.currency);
                
                // Update report range display
                document.getElementById('reportRange').textContent = 
                    `${fromDate} to ${toDate} ‚Ä¢ ${filteredTransactions.length} transactions`;
            }
        }

        // Filter transactions based on criteria
        function filterTransactions(transactions, fromDate, toDate, reportType) {
            let filtered = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                const from = fromDate ? new Date(fromDate) : null;
                const to = toDate ? new Date(toDate) : null;
                
                // Date filter
                if (from && transactionDate < from) return false;
                if (to && transactionDate > to) return false;
                
                return true;
            });

            // Apply report type specific filters
            switch (reportType) {
                case 'creditors':
                    filtered = filtered.filter(t => 
                        t.description?.includes('Creditor') || 
                        t.category?.includes('Creditor')
                    );
                    break;
                case 'debtors':
                    filtered = filtered.filter(t => 
                        t.description?.includes('Debtor') || 
                        t.category?.includes('Debtor')
                    );
                    break;
                // 'summary', 'detailed', 'category', 'balance' show all transactions
            }

            return filtered;
        }

        // Calculate report data - FIXED VERSION: Exclude creditor/debtor transactions
        function calculateReportData(transactions, userData) {
            const reportData = {
                totalIncome: 0,
                totalExpenses: 0,
                netIncome: 0,
                transactionCount: transactions.length,
                transactions: transactions,
                incomeCount: 0,
                expenseCount: 0,
                averageAmount: 0,
                incomeByCategory: {},
                expenseByCategory: {},
                balanceData: {} // For balance report
            };
            
            if (transactions.length === 0) {
                return reportData;
            }
            
            let totalAmount = 0;
            
            // Calculate totals and counts - EXCLUDING creditor/debtor transactions
            transactions.forEach(transaction => {
                // Check if transaction is creditor/debtor related
                const isCreditorDebtorTransaction = 
                    transaction.category?.includes('Creditor') || 
                    transaction.category?.includes('Debtor') ||
                    transaction.description?.includes('Creditor') || 
                    transaction.description?.includes('Debtor');
                
                if (isCreditorDebtorTransaction) {
                    return; // Skip creditor/debtor transactions
                }
                
                const amount = parseFloat(transaction.amount);
                totalAmount += amount;
                
                if (transaction.type === 'income') {
                    reportData.totalIncome += amount;
                    reportData.incomeCount++;
                    
                    // Group by category
                    if (!reportData.incomeByCategory[transaction.category]) {
                        reportData.incomeByCategory[transaction.category] = 0;
                    }
                    reportData.incomeByCategory[transaction.category] += amount;
                } else {
                    reportData.totalExpenses += amount;
                    reportData.expenseCount++;
                    
                    // Group by category
                    if (!reportData.expenseByCategory[transaction.category]) {
                        reportData.expenseByCategory[transaction.category] = 0;
                    }
                    reportData.expenseByCategory[transaction.category] += amount;
                }
            });
            
            // Calculate net and averages
            reportData.netIncome = reportData.totalIncome - reportData.totalExpenses;
            reportData.averageAmount = reportData.incomeCount + reportData.expenseCount > 0 ? 
                totalAmount / (reportData.incomeCount + reportData.expenseCount) : 0;
            
            return reportData;
        }

        // Update report summary
        function updateReportSummary(reportData, currency) {
            document.getElementById('totalIncome').textContent = formatCurrency(reportData.totalIncome, currency);
            document.getElementById('totalExpenses').textContent = formatCurrency(reportData.totalExpenses, currency);
            document.getElementById('netIncome').textContent = formatCurrency(reportData.netIncome, currency);
            document.getElementById('transactionCount').textContent = reportData.transactionCount;
            
            // Update trends with real information
            document.getElementById('incomeTrend').textContent = `${reportData.incomeCount} transactions`;
            document.getElementById('expenseTrend').textContent = `${reportData.expenseCount} transactions`;
            document.getElementById('netTrend').textContent = reportData.netIncome >= 0 ? 'Profit' : 'Loss';
            document.getElementById('balanceTrend').textContent = 'Filtered entries only';
        }

        // Update quick stats
        function updateQuickStats(reportData, currency) {
            document.getElementById('incomeCount').textContent = reportData.incomeCount;
            document.getElementById('expenseCount').textContent = reportData.expenseCount;
            document.getElementById('averageAmount').textContent = formatCurrency(reportData.averageAmount, currency);
        }

        // Update report table based on report type
        function updateReportTable(reportData, userData, reportType) {
            const container = document.getElementById('reportTableContainer');
            
            switch (reportType) {
                case 'balance':
                    container.innerHTML = generateBalanceReport(userData);
                    break;
                case 'category':
                    container.innerHTML = generateCategoryReport(reportData, userData.settings.currency);
                    break;
                case 'creditors':
                    container.innerHTML = generateCreditorsReport(userData);
                    break;
                case 'debtors':
                    container.innerHTML = generateDebtorsReport(userData);
                    break;
                default:
                    container.innerHTML = generateDetailedReport(reportData, userData.settings.currency);
            }
        }

        // Generate detailed report table
        function generateDetailedReport(reportData, currency) {
            if (reportData.transactions.length === 0) {
                return `
                    <div class="empty-state">
                        <div>üìä</div>
                        <p>No transactions found</p>
                        <p class="small">Try adjusting your filters</p>
                    </div>
                `;
            }
            
            let html = `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Balance Category</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Sort by date (newest first)
            const sortedTransactions = [...reportData.transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedTransactions.forEach(transaction => {
                const isIncome = transaction.type === 'income';
                const isCreditorDebtor = transaction.category?.includes('Creditor') || 
                                         transaction.category?.includes('Debtor');
                
                html += `
                    <tr>
                        <td>${new Date(transaction.date).toLocaleDateString()}</td>
                        <td>${transaction.description || 'No description'}</td>
                        <td>
                            <span class="category-badge ${isIncome ? 'category-income' : 'category-expense'}">
                                ${transaction.category}
                            </span>
                        </td>
                        <td>${isIncome ? 'Income' : 'Expense'}</td>
                        <td class="${isIncome ? 'amount-positive' : 'amount-negative'}">
                            ${isIncome ? '+' : '-'}${formatCurrency(transaction.amount, currency)}
                        </td>
                        <td>${transaction.balanceCategory || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }

        // Generate balance report
        function generateBalanceReport(userData) {
            const balanceCategories = userData.balanceCategories || [];
            const transactions = userData.transactions || [];
            const currency = userData.settings?.currency || '‚Çπ';
            
            if (balanceCategories.length === 0) {
                return `
                    <div class="empty-state">
                        <div>üí∞</div>
                        <p>No balance categories found</p>
                        <p class="small">Add balance categories in Admin section</p>
                    </div>
                `;
            }
            
            // Calculate current balances for each category
            const balanceData = balanceCategories.map(category => {
                let balance = parseFloat(category.amount) || 0;
                
                // Add income transactions
                transactions
                    .filter(t => t.balanceCategory === category.name && t.type === 'income')
                    .forEach(t => balance += parseFloat(t.amount));
                
                // Subtract expense transactions
                transactions
                    .filter(t => t.balanceCategory === category.name && t.type === 'expense')
                    .forEach(t => balance -= parseFloat(t.amount));
                
                return {
                    ...category,
                    currentBalance: balance
                };
            });
            
            // Calculate total balance
            const totalBalance = balanceData.reduce((sum, category) => sum + category.currentBalance, 0);
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">Balance Summary</h3>
                <table class="balance-report-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Balance Category</th>
                            <th>Type</th>
                            <th>Initial Amount</th>
                            <th>Current Balance</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            balanceData.forEach(category => {
                const initialAmount = parseFloat(category.amount) || 0;
                const difference = category.currentBalance - initialAmount;
                const differenceClass = difference >= 0 ? 'amount-positive' : 'amount-negative';
                const differenceSign = difference >= 0 ? '+' : '';
                
                html += `
                    <tr>
                        <td><strong>${category.name}</strong></td>
                        <td>${category.type}</td>
                        <td>${formatCurrency(initialAmount, currency)}</td>
                        <td><strong>${formatCurrency(category.currentBalance, currency)}</strong></td>
                        <td class="${differenceClass}">${differenceSign}${formatCurrency(difference, currency)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #f8f9fa;">
                            <td colspan="3"><strong>Total Balance</strong></td>
                            <td colspan="2"><strong style="font-size: 18px;">${formatCurrency(totalBalance, currency)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;
            
            // Add balance cards for each type
            const types = ['Cash', 'Bank', 'Wallet', 'Voucher', 'Other'];
            types.forEach(type => {
                const typeCategories = balanceData.filter(cat => cat.type === type);
                if (typeCategories.length > 0) {
                    const typeTotal = typeCategories.reduce((sum, cat) => sum + cat.currentBalance, 0);
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="font-size: 12px; color: #7f8c8d;">${type}</div>
                            <div style="font-size: 20px; font-weight: 700; margin-top: 5px;">${formatCurrency(typeTotal, currency)}</div>
                            <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">${typeCategories.length} account${typeCategories.length !== 1 ? 's' : ''}</div>
                        </div>
                    `;
                }
            });
            
            html += `</div>`;
            
            return html;
        }

        // Generate category report
        function generateCategoryReport(reportData, currency) {
            const { incomeByCategory, expenseByCategory } = reportData;
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">Category-wise Report</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: var(--success); margin-bottom: 15px;">üì• Income Categories</h4>
            `;
            
            if (Object.keys(incomeByCategory).length === 0) {
                html += `<p style="color: #7f8c8d; text-align: center; padding: 20px;">No income transactions</p>`;
            } else {
                html += `<table class="report-table" style="width: 100%;">`;
                Object.entries(incomeByCategory).forEach(([category, amount]) => {
                    html += `
                        <tr>
                            <td>${category}</td>
                            <td class="amount-positive">+${formatCurrency(amount, currency)}</td>
                        </tr>
                    `;
                });
                html += `</table>`;
            }
            
            html += `
                    </div>
                    <div>
                        <h4 style="color: var(--danger); margin-bottom: 15px;">üì§ Expense Categories</h4>
            `;
            
            if (Object.keys(expenseByCategory).length === 0) {
                html += `<p style="color: #7f8c8d; text-align: center; padding: 20px;">No expense transactions</p>`;
            } else {
                html += `<table class="report-table" style="width: 100%;">`;
                Object.entries(expenseByCategory).forEach(([category, amount]) => {
                    html += `
                        <tr>
                            <td>${category}</td>
                            <td class="amount-negative">-${formatCurrency(amount, currency)}</td>
                        </tr>
                    `;
                });
                html += `</table>`;
            }
            
            html += `</div></div>`;
            return html;
        }

        // Generate creditors report
        function generateCreditorsReport(userData) {
            const creditors = userData.creditors || [];
            const currency = userData.settings?.currency || '‚Çπ';
            
            if (creditors.length === 0) {
                return `
                    <div class="empty-state">
                        <div>üë•</div>
                        <p>No creditors found</p>
                        <p class="small">Add creditors in Creditors section</p>
                    </div>
                `;
            }
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">Creditors Report</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Total Amount</th>
                            <th>Paid Amount</th>
                            <th>Pending Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            creditors.forEach(creditor => {
                const totalAmount = parseFloat(creditor.amount) || 0;
                const paidAmount = parseFloat(creditor.paidAmount) || 0;
                const pendingAmount = totalAmount - paidAmount;
                const status = creditor.status || 'pending';
                const statusClass = status === 'settled' ? 'amount-positive' : 'amount-negative';
                
                html += `
                    <tr>
                        <td>${creditor.name}</td>
                        <td>${formatCurrency(totalAmount, currency)}</td>
                        <td>${formatCurrency(paidAmount, currency)}</td>
                        <td class="${statusClass}">${formatCurrency(pendingAmount, currency)}</td>
                        <td>
                            <span class="category-badge ${status === 'settled' ? 'category-income' : 'category-expense'}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        // Generate debtors report
        function generateDebtorsReport(userData) {
            const debtors = userData.debtors || [];
            const currency = userData.settings?.currency || '‚Çπ';
            
            if (debtors.length === 0) {
                return `
                    <div class="empty-state">
                        <div>üë§</div>
                        <p>No debtors found</p>
                        <p class="small">Add debtors in Debtors section</p>
                    </div>
                `;
            }
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">Debtors Report</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Total Amount</th>
                            <th>Received Amount</th>
                            <th>Pending Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            debtors.forEach(debtor => {
                const totalAmount = parseFloat(debtor.amount) || 0;
                const receivedAmount = parseFloat(debtor.receivedAmount) || 0;
                const pendingAmount = totalAmount - receivedAmount;
                const status = debtor.status || 'pending';
                const statusClass = status === 'settled' ? 'amount-positive' : 'amount-negative';
                
                html += `
                    <tr>
                        <td>${debtor.name}</td>
                        <td>${formatCurrency(totalAmount, currency)}</td>
                        <td>${formatCurrency(receivedAmount, currency)}</td>
                        <td class="${statusClass}">${formatCurrency(pendingAmount, currency)}</td>
                        <td>
                            <span class="category-badge ${status === 'settled' ? 'category-income' : 'category-expense'}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        // Format currency
        function formatCurrency(amount, currency) {
            return `${currency}${parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Generate report
            document.getElementById('generateReport').addEventListener('click', function() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                loadReportData(currentUser.voucherCode);
                alert('Report generated successfully!');
            });
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', function() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                loadReportData(currentUser.voucherCode);
            });
            
            // Period change
            document.getElementById('reportPeriod').addEventListener('change', function() {
                updateDateRangeByPeriod(this.value);
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                loadReportData(currentUser.voucherCode);
            });
            
            // Preview report
            document.getElementById('previewReport').addEventListener('click', function() {
                showPreviewReport();
            });
            
            // Clear filters
            document.getElementById('clearFilters').addEventListener('click', function() {
                document.getElementById('reportType').value = 'summary';
                document.getElementById('reportPeriod').value = 'thisMonth';
                updateDateRangeByPeriod('thisMonth');
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                loadReportData(currentUser.voucherCode);
                alert('Filters cleared!');
            });
            
            // Export functions
            document.getElementById('exportCSV').addEventListener('click', function() {
                exportReport('csv');
            });
            
            document.getElementById('exportExcel').addEventListener('click', function() {
                exportReport('excel');
            });
            
            document.getElementById('exportHTML').addEventListener('click', function() {
                exportReport('html');
            });
            
            // Close preview modal
            document.querySelector('.close-preview').addEventListener('click', function() {
                document.getElementById('previewModal').style.display = 'none';
            });
            
            // Close modal when clicking outside
            document.getElementById('previewModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
        }

        // Show preview report
        function showPreviewReport() {
            if (!currentReportData || currentReportData.transactions.length === 0) {
                alert('Please generate a report first');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const userData = JSON.parse(localStorage.getItem(`userData_${currentUser.voucherCode}`));
            
            const previewContent = document.getElementById('previewContent');
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const reportType = document.getElementById('reportType').value;
            
            previewContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin-bottom: 10px;">Financial Report Preview</h3>
                    <p style="color: #7f8c8d;">
                        <strong>Period:</strong> ${fromDate} to ${toDate} | 
                        <strong>Type:</strong> ${reportType} | 
                        <strong>Transactions:</strong> ${currentReportData.transactionCount}
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #7f8c8d;">Total Income (Entries Only)</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--success);">
                            ${formatCurrency(currentReportData.totalIncome, userData.settings.currency)}
                        </div>
                    </div>
                    <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #7f8c8d;">Total Expenses (Entries Only)</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--danger);">
                            ${formatCurrency(currentReportData.totalExpenses, userData.settings.currency)}
                        </div>
                    </div>
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #7f8c8d;">Net Income</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--info);">
                            ${formatCurrency(currentReportData.netIncome, userData.settings.currency)}
                        </div>
                    </div>
                    <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #7f8c8d;">Transaction Count</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--warning);">
                            ${currentReportData.transactionCount}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--dark); margin-bottom: 10px;">Report Summary</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p><strong>Income Transactions:</strong> ${currentReportData.incomeCount}</p>
                        <p><strong>Expense Transactions:</strong> ${currentReportData.expenseCount}</p>
                        <p><strong>Average Transaction:</strong> ${formatCurrency(currentReportData.averageAmount, userData.settings.currency)}</p>
                        <p><strong>Report Type:</strong> ${reportType}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('previewModal').style.display = 'flex';
        }

        // Update date range based on period selection
        function updateDateRangeByPeriod(period) {
            const today = new Date();
            let fromDate, toDate;
            
            switch (period) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    fromDate = yesterday;
                    toDate = yesterday;
                    break;
                case 'thisWeek':
                    const firstDayOfWeek = new Date(today);
                    firstDayOfWeek.setDate(today.getDate() - today.getDay());
                    fromDate = firstDayOfWeek;
                    toDate = today;
                    break;
                case 'lastWeek':
                    const lastWeekStart = new Date(today);
                    lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
                    const lastWeekEnd = new Date(lastWeekStart);
                    lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                    fromDate = lastWeekStart;
                    toDate = lastWeekEnd;
                    break;
                case 'thisMonth':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = today;
                    break;
                case 'lastMonth':
                    fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    toDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    fromDate = new Date(today.getFullYear(), quarter * 3, 1);
                    toDate = today;
                    break;
                case 'lastQuarter':
                    const lastQuarter = Math.floor(today.getMonth() / 3) - 1;
                    if (lastQuarter < 0) {
                        fromDate = new Date(today.getFullYear() - 1, 9, 1);
                        toDate = new Date(today.getFullYear() - 1, 11, 31);
                    } else {
                        fromDate = new Date(today.getFullYear(), lastQuarter * 3, 1);
                        toDate = new Date(today.getFullYear(), (lastQuarter + 1) * 3, 0);
                    }
                    break;
                case 'thisYear':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    toDate = today;
                    break;
                case 'lastYear':
                    fromDate = new Date(today.getFullYear() - 1, 0, 1);
                    toDate = new Date(today.getFullYear() - 1, 11, 31);
                    break;
                default:
                    return; // custom range - don't change dates
            }
            
            document.getElementById('fromDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('toDate').value = toDate.toISOString().split('T')[0];
        }

        // Export report
        function exportReport(format) {
            if (!currentReportData || currentReportData.transactions.length === 0) {
                alert('Please generate a report first');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const userData = JSON.parse(localStorage.getItem(`userData_${currentUser.voucherCode}`));
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            switch (format) {
                case 'csv':
                    content = generateCSVContent(currentReportData, userData.settings.currency);
                    filename = `financial_report_${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
                case 'excel':
                    content = generateExcelContent(currentReportData, userData.settings.currency);
                    filename = `financial_report_${new Date().toISOString().split('T')[0]}.xls`;
                    mimeType = 'application/vnd.ms-excel';
                    break;
                case 'html':
                    content = generateHTMLContent(currentReportData, userData.settings.currency);
                    filename = `financial_report_${new Date().toISOString().split('T')[0]}.html`;
                    mimeType = 'text/html';
                    break;
            }
            
            // Create download link
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`${format.toUpperCase()} report downloaded successfully!`);
        }

        // Generate CSV content
        function generateCSVContent(reportData, currency) {
            let csv = 'Financial Report\n\n';
            csv += `Period,${document.getElementById('fromDate').value} to ${document.getElementById('toDate').value}\n`;
            csv += `Report Type,${document.getElementById('reportType').value}\n`;
            csv += `Total Income (Entries Only),${formatCurrency(reportData.totalIncome, currency).replace(currency, '')}\n`;
            csv += `Total Expenses (Entries Only),${formatCurrency(reportData.totalExpenses, currency).replace(currency, '')}\n`;
            csv += `Net Income,${formatCurrency(reportData.netIncome, currency).replace(currency, '')}\n`;
            csv += `Transaction Count,${reportData.transactionCount}\n\n`;
            
            if (currentReportType === 'balance') {
                csv += 'Balance Report\n';
                csv += 'Category,Type,Initial Amount,Current Balance,Difference\n';
                // Add balance data
            } else {
                csv += 'Transaction Details\n';
                csv += 'Date,Description,Category,Type,Amount,Balance Category\n';
                reportData.transactions.forEach(transaction => {
                    csv += `"${transaction.date}","${transaction.description || ''}","${transaction.category}","${transaction.type}","${transaction.amount}","${transaction.balanceCategory || ''}"\n`;
                });
            }
            
            return csv;
        }

        // Generate Excel content
        function generateExcelContent(reportData, currency) {
            // Simple HTML table that Excel can open
            return generateHTMLContent(reportData, currency);
        }

        // Generate HTML content
        function generateHTMLContent(reportData, currency) {
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Financial Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .summary-card { padding: 20px; border-radius: 8px; text-align: center; }
                        .income { background: #d4edda; color: #155724; }
                        .expense { background: #f8d7da; color: #721c24; }
                        .net { background: #e2e3e5; color: #383d41; }
                        .count { background: #fff3cd; color: #856404; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f8f9fa; }
                        .positive { color: #155724; font-weight: bold; }
                        .negative { color: #721c24; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Financial Report</h1>
                        <p>Period: ${document.getElementById('fromDate').value} to ${document.getElementById('toDate').value}</p>
                        <p>Report Type: ${document.getElementById('reportType').value}</p>
                        <p><strong>Note:</strong> Income & Expenses calculated from ENTRIES only (excludes creditor/debtor transactions)</p>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-card income">
                            <h3>Total Income</h3>
                            <h2>${formatCurrency(reportData.totalIncome, currency)}</h2>
                            <small>Entries only</small>
                        </div>
                        <div class="summary-card expense">
                            <h3>Total Expenses</h3>
                            <h2>${formatCurrency(reportData.totalExpenses, currency)}</h2>
                            <small>Entries only</small>
                        </div>
                        <div class="summary-card net">
                            <h3>Net Income</h3>
                            <h2>${formatCurrency(reportData.netIncome, currency)}</h2>
                        </div>
                        <div class="summary-card count">
                            <h3>Transactions</h3>
                            <h2>${reportData.transactionCount}</h2>
                        </div>
                    </div>
                    
                    <h2>Report Details</h2>
                    <p><strong>Income Transactions:</strong> ${reportData.incomeCount}</p>
                    <p><strong>Expense Transactions:</strong> ${reportData.expenseCount}</p>
                    <p><strong>Average Transaction:</strong> ${formatCurrency(reportData.averageAmount, currency)}</p>
                    
                    <div style="margin-top: 30px; text-align: center; color: #6c757d; font-size: 12px;">
                        Generated on ${new Date().toLocaleDateString()} by Income & Expenses Tracker
                    </div>
                </body>
                </html>
            `;
            
            return html;
        }
    </script>
</body>
</html>