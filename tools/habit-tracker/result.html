<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker - Results & Analytics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 2.2em;
        }

        .header h1 i {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .date-range {
            background: #f0f4ff;
            padding: 15px 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-range select {
            border: none;
            background: transparent;
            font-size: 16px;
            padding: 8px;
            border-bottom: 2px solid #667eea;
            outline: none;
            cursor: pointer;
            font-weight: 600;
            color: #333;
        }

        /* Export Buttons */
        .export-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .export-btn.csv {
            border-color: #27ae60;
            color: #27ae60;
        }

        .export-btn.excel {
            border-color: #217346;
            color: #217346;
        }

        .export-btn.google {
            border-color: #4285f4;
            color: #4285f4;
        }

        .export-btn.sync {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        /* Google Sheets Connect Section */
        .google-connect {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .google-connect.show {
            display: block;
        }

        .google-connect h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .google-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .google-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .google-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .google-input-group button {
            padding: 12px 25px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .sync-status {
            font-size: 14px;
            color: #27ae60;
            display: none;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
        }

        .card-content h3 {
            color: #666;
            font-size: 14px;
            font-weight: normal;
            margin-bottom: 5px;
        }

        .card-content .number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .card-content .trend {
            font-size: 14px;
            margin-top: 5px;
        }

        .trend.up {
            color: #2ecc71;
        }

        .trend.down {
            color: #e74c3c;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .progress-circle {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            position: relative;
        }

        .circle-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 3.8;
        }

        .circle-progress {
            fill: none;
            stroke: #667eea;
            stroke-width: 3.8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .circle-text {
            font-size: 2em;
            font-weight: bold;
            fill: #333;
        }

        .progress-label {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        /* Habits Performance */
        .performance-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .performance-header h2 {
            color: #333;
            font-size: 1.6em;
        }

        .filter-btns {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        .filter-btn:hover {
            border-color: #667eea;
        }

        /* Habits Table */
        .habits-table {
            width: 100%;
            border-collapse: collapse;
        }

        .habits-table th {
            text-align: left;
            padding: 15px 10px;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        .habits-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .habit-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .habit-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .habit-name {
            font-weight: 600;
            color: #333;
        }

        .habit-category {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 10px;
            border-radius: 12px;
        }

        .progress-bar-mini {
            width: 150px;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        .streak-badge {
            background: #fff3e0;
            color: #f39c12;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .completion-rate {
            font-weight: 600;
            color: #27ae60;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-btn.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .no-data i {
            font-size: 60px;
            color: #667eea;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1><i>üìä</i> Habit Analytics & Results</h1>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="date-range">
                    <span>üìÖ</span>
                    <select id="timeRange" onchange="updateResults()">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                        <option value="all">All time</option>
                    </select>
                </div>
                <div class="export-section">
                    <button class="export-btn csv" onclick="exportToCSV()">
                        <i>üìÑ</i> CSV
                    </button>
                    <button class="export-btn excel" onclick="exportToExcel()">
                        <i>üìä</i> Excel
                    </button>
                    <button class="export-btn google" onclick="toggleGoogleConnect()">
                        <i>üìà</i> Google Sheets
                    </button>
                    <button class="export-btn sync" onclick="syncAllToGoogleSheets()">
                        <i>üîÑ</i> Sync Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Google Sheets Connect Section -->
        <div id="googleConnect" class="google-connect">
            <h3><i>üîó</i> Connect to Google Sheets</h3>
            <div class="google-input-group">
                <input type="url" id="googleSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." value="">
                <button onclick="connectGoogleSheet()">Connect</button>
            </div>
            <div id="syncStatus" class="sync-status">
                <i>‚úì</i> Connected - Auto-sync enabled
            </div>
            <div id="lastSync" style="font-size: 12px; color: #666; margin-top: 5px;">
                Last sync: Never
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards" id="summaryCards">
            <!-- Dynamically filled -->
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h2>üìà Completion Trend</h2>
                <div style="height: 200px; display: flex; align-items: flex-end; gap: 10px;" id="trendChart">
                    <!-- Bars will be added here -->
                </div>
            </div>
            <div class="chart-card">
                <h2>üéØ Overall Progress</h2>
                <div class="progress-circle">
                    <svg viewBox="0 0 100 100" width="200" height="200">
                        <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
                        <circle class="circle-progress" cx="50" cy="50" r="45" stroke-dasharray="0 283" id="progressCircle"></circle>
                        <text x="50" y="50" text-anchor="middle" dy="0.3em" class="circle-text" id="progressPercent">0%</text>
                    </svg>
                </div>
                <div class="progress-label" id="progressLabel">Overall completion rate</div>
            </div>
        </div>

        <!-- Habits Performance Table -->
        <div class="performance-section">
            <div class="performance-header">
                <h2>üìã Habit Performance</h2>
                <div class="filter-btns">
                    <button class="filter-btn active" onclick="filterHabits('all')" id="filterAll">All</button>
                    <button class="filter-btn" onclick="filterHabits('completed')" id="filterCompleted">Completed</button>
                    <button class="filter-btn" onclick="filterHabits('pending')" id="filterPending">Pending</button>
                </div>
            </div>

            <div id="habitsTableContainer">
                <table class="habits-table" id="habitsTable">
                    <thead>
                        <tr>
                            <th>Habit</th>
                            <th>Category</th>
                            <th>Progress</th>
                            <th>Streak</th>
                            <th>Completion Rate</th>
                        </tr>
                    </thead>
                    <tbody id="habitsTableBody">
                        <!-- Dynamically filled -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="index.html" class="action-btn secondary">‚Üê Back to Dashboard</a>
            <a href="create-habit.html" class="action-btn primary">+ Create New Habit</a>
        </div>
    </div>

    <script>
        // Google Sheets connection
        let googleSheetUrl = localStorage.getItem('googleSheetUrl') || '';
        
        function toggleGoogleConnect() {
            document.getElementById('googleConnect').classList.toggle('show');
            if (googleSheetUrl) {
                document.getElementById('googleSheetUrl').value = googleSheetUrl;
                document.getElementById('syncStatus').style.display = 'block';
            }
        }

        function connectGoogleSheet() {
            const url = document.getElementById('googleSheetUrl').value;
            if (url) {
                googleSheetUrl = url;
                localStorage.setItem('googleSheetUrl', url);
                document.getElementById('syncStatus').style.display = 'block';
                document.getElementById('lastSync').innerHTML = `Last sync: ${new Date().toLocaleString()}`;
                
                // Initial sync
                syncAllToGoogleSheets();
                
                // Set up auto-sync based on user preferences
                setupAutoSync();
            }
        }

        function setupAutoSync() {
            const habits = JSON.parse(localStorage.getItem('habits')) || [];
            habits.forEach(habit => {
                if (habit.autoSync && habit.autoSync !== 'manual') {
                    let interval = 3600000; // Default hourly
                    
                    if (habit.autoSync === 'daily') {
                        interval = 86400000; // 24 hours
                    } else if (habit.autoSync === 'weekly') {
                        interval = 604800000; // 7 days
                    }
                    
                    setInterval(() => {
                        syncToGoogleSheet(habit);
                    }, interval);
                }
            });
        }

        async function syncToGoogleSheet(habit) {
            if (!googleSheetUrl) return;
            
            try {
                // Prepare data for export
                const data = {
                    habit: habit.name,
                    category: habit.category,
                    date: new Date().toISOString().split('T')[0],
                    streak: habit.streak || 0,
                    completed: habit.completedDates?.length || 0,
                    target: habit.targetDays,
                    completionRate: calculateCompletionRate(habit, getDateRange(document.getElementById('timeRange').value))
                };

                // In production, you would use the Google Sheets API
                // For demo, we'll store in localStorage
                const exportedData = JSON.parse(localStorage.getItem('exportedData')) || [];
                exportedData.push({
                    ...data,
                    exportedAt: new Date().toISOString()
                });
                localStorage.setItem('exportedData', JSON.stringify(exportedData));
                
                console.log('Synced to Google Sheets:', data);
                
                document.getElementById('lastSync').innerHTML = `Last sync: ${new Date().toLocaleString()}`;
                
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        async function syncAllToGoogleSheets() {
            if (!googleSheetUrl) {
                alert('Please connect to Google Sheets first');
                toggleGoogleConnect();
                return;
            }
            
            const habits = JSON.parse(localStorage.getItem('habits')) || [];
            for (const habit of habits) {
                await syncToGoogleSheet(habit);
            }
            
            alert('Data synced to Google Sheets successfully!');
        }

        // Export to CSV
        function exportToCSV() {
            const habits = JSON.parse(localStorage.getItem('habits')) || [];
            const rangeValue = document.getElementById('timeRange').value;
            const dateRange = getDateRange(rangeValue);
            
            // Prepare CSV data
            let csv = 'Habit Name,Category,Streak,Completed Days,Target Days,Completion Rate,Created At\n';
            
            habits.forEach(habit => {
                const rate = calculateCompletionRate(habit, dateRange);
                csv += `"${habit.name}","${habit.category}",${habit.streak || 0},${habit.completedDates?.length || 0},${habit.targetDays},${rate}%,"${habit.createdAt}"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Export to Excel (XLSX format using CSV with .xlsx extension)
        function exportToExcel() {
            const habits = JSON.parse(localStorage.getItem('habits')) || [];
            const rangeValue = document.getElementById('timeRange').value;
            const dateRange = getDateRange(rangeValue);
            
            // Create detailed data for Excel
            let data = [['Habit Name', 'Category', 'Description', 'Streak', 'Completed Days', 'Target Days', 'Completion Rate', 'Created At']];
            
            habits.forEach(habit => {
                const rate = calculateCompletionRate(habit, dateRange);
                data.push([
                    habit.name,
                    habit.category,
                    habit.description || '',
                    habit.streak || 0,
                    habit.completedDates?.length || 0,
                    habit.targetDays,
                    `${rate}%`,
                    habit.createdAt
                ]);
            });
            
            // Convert to CSV
            let csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            // Download as Excel (CSV with .xlsx extension for compatibility)
            const blob = new Blob([csv], { type: 'application/vnd.ms-excel' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-${new Date().toISOString().split('T')[0]}.xlsx`;
            a.click();
        }

        // Get date range from select
        function getDateRange(days) {
            if (days === 'all') return null;
            
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - parseInt(days));
            
            return {
                start: formatDate(start),
                end: formatDate(end)
            };
        }

        // Format date to YYYY-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Calculate completion rate for a habit
        function calculateCompletionRate(habit, dateRange) {
            if (!habit.completedDates || habit.completedDates.length === 0) return 0;
            
            let completedCount = habit.completedDates.length;
            if (dateRange) {
                completedCount = habit.completedDates.filter(date => 
                    date >= dateRange.start && date <= dateRange.end
                ).length;
            }
            
            const total = dateRange ? parseInt(document.getElementById('timeRange').value) : habit.totalDays;
            return Math.min(Math.round((completedCount / total) * 100), 100);
        }

        // Update summary cards
        function updateSummaryCards(habits, dateRange) {
            const totalHabits = habits.length;
            
            // Calculate active habits (completed at least once in range)
            const activeHabits = habits.filter(habit => {
                if (!habit.completedDates) return false;
                if (!dateRange) return habit.completedDates.length > 0;
                return habit.completedDates.some(date => date >= dateRange.start && date <= dateRange.end);
            }).length;
            
            // Calculate total completions
            const totalCompletions = habits.reduce((sum, habit) => {
                if (!habit.completedDates) return sum;
                if (!dateRange) return sum + habit.completedDates.length;
                return sum + habit.completedDates.filter(date => 
                    date >= dateRange.start && date <= dateRange.end
                ).length;
            }, 0);
            
            // Calculate average streak
            const avgStreak = habits.length > 0 
                ? Math.round(habits.reduce((sum, h) => sum + (h.streak || 0), 0) / habits.length)
                : 0;

            const summaryHTML = `
                <div class="summary-card">
                    <div class="card-icon">üìä</div>
                    <div class="card-content">
                        <h3>Total Habits</h3>
                        <div class="number">${totalHabits}</div>
                        <div class="trend up">Active: ${activeHabits}</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">‚úì</div>
                    <div class="card-content">
                        <h3>Completions</h3>
                        <div class="number">${totalCompletions}</div>
                        <div class="trend up">+${Math.round(totalCompletions/7)} this week</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">üî•</div>
                    <div class="card-content">
                        <h3>Avg Streak</h3>
                        <div class="number">${avgStreak}</div>
                        <div class="trend up">days</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">‚≠ê</div>
                    <div class="card-content">
                        <h3>Best Habit</h3>
                        <div class="number">${habits.length > 0 ? habits.sort((a,b) => (b.streak || 0) - (a.streak || 0))[0].name : 'None'}</div>
                        <div class="trend up">${habits.length > 0 ? Math.max(...habits.map(h => h.streak || 0)) : 0} day streak</div>
                    </div>
                </div>
            `;
            
            document.getElementById('summaryCards').innerHTML = summaryHTML;
        }

        // Update trend chart
        function updateTrendChart(habits, dateRange) {
            const chart = document.getElementById('trendChart');
            if (!dateRange) {
                chart.innerHTML = '<div style="width:100%; text-align:center; color:#666;">Select a date range to view trends</div>';
                return;
            }

            const days = parseInt(document.getElementById('timeRange').value);
            const data = [];
            
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = formatDate(date);
                
                const completions = habits.filter(habit => 
                    habit.completedDates && habit.completedDates.includes(dateStr)
                ).length;
                
                data.unshift(completions);
            }

            const maxCompletions = Math.max(...data, 1);
            
            chart.innerHTML = data.map((value, index) => {
                const height = (value / maxCompletions) * 150;
                const day = new Date();
                day.setDate(day.getDate() - (data.length - 1 - index));
                const label = day.toLocaleDateString('en-US', { weekday: 'short' });
                
                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <div style="height: 150px; width: 100%; display: flex; align-items: flex-end;">
                            <div style="background: linear-gradient(180deg, #667eea, #764ba2); width: 70%; margin: 0 auto; height: ${height}px; border-radius: 5px 5px 0 0;"></div>
                        </div>
                        <span style="font-size: 10px; color: #666;">${label}</span>
                        <span style="font-size: 10px; font-weight: bold;">${value}</span>
                    </div>
                `;
            }).join('');
        }

        // Update progress circle
        function updateProgressCircle(habits, dateRange) {
            let totalRate = 0;
            
            habits.forEach(habit => {
                totalRate += calculateCompletionRate(habit, dateRange);
            });
            
            const avgRate = habits.length > 0 ? Math.round(totalRate / habits.length) : 0;
            const circumference = 2 * Math.PI * 45;
            const dashArray = (avgRate / 100) * circumference;
            
            document.getElementById('progressCircle').setAttribute('stroke-dasharray', `${dashArray} ${circumference}`);
            document.getElementById('progressPercent').textContent = avgRate + '%';
            document.getElementById('progressLabel').textContent = habits.length > 0 
                ? `${habits.filter(h => calculateCompletionRate(h, dateRange) >= 80).length} habits on track` 
                : 'No habits yet';
        }

        // Update habits table
        function updateHabitsTable(habits, dateRange, filter = 'all') {
            const tbody = document.getElementById('habitsTableBody');
            
            if (habits.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="no-data">
                                <i>üìù</i>
                                <h3>No habits found</h3>
                                <p>Create your first habit to start tracking!</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            let filteredHabits = [...habits];
            
            if (filter === 'completed') {
                filteredHabits = habits.filter(h => calculateCompletionRate(h, dateRange) >= 80);
            } else if (filter === 'pending') {
                filteredHabits = habits.filter(h => calculateCompletionRate(h, dateRange) < 80);
            }

            tbody.innerHTML = filteredHabits.map(habit => {
                const rate = calculateCompletionRate(habit, dateRange);
                const completedCount = dateRange 
                    ? habit.completedDates?.filter(d => d >= dateRange.start && d <= dateRange.end).length || 0
                    : habit.completedDates?.length || 0;
                const total = dateRange ? parseInt(document.getElementById('timeRange').value) : habit.totalDays;
                
                return `
                    <tr>
                        <td>
                            <div class="habit-info">
                                <div class="habit-color" style="background: ${habit.color || '#667eea'}"></div>
                                <span class="habit-name">${habit.name}</span>
                            </div>
                        </td>
                        <td><span class="habit-category">${habit.category}</span></td>
                        <td>
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: ${rate}%"></div>
                            </div>
                            <span style="font-size: 12px;">${completedCount}/${total} days</span>
                        </td>
                        <td>
                            <span class="streak-badge">
                                üî• ${habit.streak || 0} days
                            </span>
                        </td>
                        <td>
                            <span class="completion-rate">${rate}%</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Main update function
        function updateResults() {
            const habits = JSON.parse(localStorage.getItem('habits')) || [];
            const rangeValue = document.getElementById('timeRange').value;
            const dateRange = getDateRange(rangeValue);
            
            updateSummaryCards(habits, dateRange);
            updateTrendChart(habits, dateRange);
            updateProgressCircle(habits, dateRange);
            updateHabitsTable(habits, dateRange, currentFilter);
        }

        // Filter habits
        let currentFilter = 'all';
        
        function filterHabits(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
            
            // Update table
            const habits = JSON.parse(localStorage.getItem('habits')) || [];
            const rangeValue = document.getElementById('timeRange').value;
            const dateRange = getDateRange(rangeValue);
            
            updateHabitsTable(habits, dateRange, filter);
        }

        // Initialize on load
        window.onload = function() {
            updateResults();
            
            // Check for saved Google Sheet URL
            if (googleSheetUrl) {
                document.getElementById('googleSheetUrl').value = googleSheetUrl;
                document.getElementById('syncStatus').style.display = 'block';
                setupAutoSync();
            }
        };
    </script>
</body>
</html>
